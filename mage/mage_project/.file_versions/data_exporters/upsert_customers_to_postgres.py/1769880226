import json
import psycopg2
from psycopg2.extras import execute_values

from mage_ai.data_preparation.shared.secrets import get_secret_value
from pandas import DataFrame

if "data_exporter" not in globals():
    from mage_ai.data_preparation.decorators import data_exporter


def _require_secret(key: str) -> str:
    val = get_secret_value(key)
    if not val:
        raise ValueError(f"Missing required Mage Secret: {key}")
    return val


@data_exporter
def export_data_to_postgres(df: DataFrame, **kwargs) -> None:
    """
    UPSERT into raw.qb_customers

    Expected df columns:
      - id (text)
      - payload (json string)
      - extract_window_start_utc (ISO string)
      - extract_window_end_utc (ISO string)
      - page_number (int)
      - page_size (int)
      - request_payload (json string)
    """
    schema_name = "raw"
    table_name = "qb_customers"

    host = _require_secret("POSTGRES_HOST")
    port = int(_require_secret("POSTGRES_PORT"))
    db = _require_secret("POSTGRES_DB")
    user = _require_secret("POSTGRES_USER")
    password = _require_secret("POSTGRES_PASSWORD")

    if df is None or df.empty:
        return

    def _to_json_str(x):
        if x is None:
            return None
        if isinstance(x, (dict, list)):
            return json.dumps(x)
        return str(x)

    values = []
    for row in df.to_dict(orient="records"):
        values.append((
            str(row["id"]),
            _to_json_str(row["payload"]),
            row["extract_window_start_utc"],
            row["extract_window_end_utc"],
            int(row["page_number"]),
            int(row["page_size"]),
            _to_json_str(row.get("request_payload")),
        ))

    upsert_sql = f"""
    INSERT INTO {schema_name}.{table_name}
      (id, payload, extract_window_start_utc, extract_window_end_utc, page_number, page_size, request_payload)
    VALUES %s
    ON CONFLICT (id) DO UPDATE SET
      payload = EXCLUDED.payload::jsonb,
      ingested_at_utc = now(),
      extract_window_start_utc = EXCLUDED.extract_window_start_utc,
      extract_window_end_utc = EXCLUDED.extract_window_end_utc,
      page_number = EXCLUDED.page_number,
      page_size = EXCLUDED.page_size,
      request_payload = EXCLUDED.request_payload::jsonb;
    """

    conn = psycopg2.connect(
        host=host,
        port=port,
        dbname=db,
        user=user,
        password=password,
    )
    conn.autocommit = False

    try:
        with conn.cursor() as cur:
            execute_values(cur, upsert_sql, values, page_size=500)
        conn.commit()
    except Exception:
        conn.rollback()
        raise
    finally:
        conn.close()
